<Project Sdk="Microsoft.NET.Sdk">

    <PropertyGroup>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
        <IsPackable>false</IsPackable>
        <EmitCompilerGeneratedFiles>true</EmitCompilerGeneratedFiles>
        <CompilerGeneratedFilesOutputPath>$(BaseIntermediateOutputPath)Generated</CompilerGeneratedFilesOutputPath>
        <!-- Force analyzer to reload on every build to avoid caching issues -->
        <EnforceExtendedAnalyzerRules>true</EnforceExtendedAnalyzerRules>
    </PropertyGroup>
    
    <!-- Configure global exclusions for DTO generator -->
    <ItemGroup>
        <CompilerVisibleProperty Include="DtoGenerator_GlobalExclusions" />
    </ItemGroup>
    
    <PropertyGroup>
        <DtoGenerator_GlobalExclusions>CreatedBy,UpdatedBy,CreatedAt,UpdatedAt</DtoGenerator_GlobalExclusions>
    </PropertyGroup>

    <!-- Custom target to copy generated DTOs to project/GeneratedDtos folder, flattening structure and preserving names/extensions -->
    <Target Name="CopyGeneratedDtosToOutputFolder" AfterTargets="CoreCompile" Condition="Exists('$(CompilerGeneratedFilesOutputPath)')">
        <ItemGroup>
            <GeneratedDtoFiles Include="$(CompilerGeneratedFilesOutputPath)\**\*.g.cs"/>
        </ItemGroup>
        <MakeDir Directories="$(ProjectDir)GeneratedDtos" Condition="'@(GeneratedDtoFiles)' != ''"/>
        <Copy SourceFiles="@(GeneratedDtoFiles)"
              DestinationFiles="$(ProjectDir)GeneratedDtos\%(Filename)%(Extension)"
              SkipUnchangedFiles="false"
              OverwriteReadOnlyFiles="true"
              Condition="'@(GeneratedDtoFiles)' != ''"/>
        <Message Text="Copied %(Filename)%(Extension) to $(ProjectDir)GeneratedDtos" Importance="high" Condition="'@(GeneratedDtoFiles)' != ''"/>
    </Target>

    <!-- Exclude generated DTOs from compilation, but keep them visible in Solution Explorer -->
    <ItemGroup>
        <Compile Remove="GeneratedDtos\**\*.cs"/>
        <None Include="GeneratedDtos\**\*.cs"/>
    </ItemGroup>

    <ItemGroup>
        <PackageReference Include="coverlet.collector"/>
        <PackageReference Include="Microsoft.NET.Test.Sdk"/>
        <PackageReference Include="xunit"/>
        <PackageReference Include="xunit.runner.visualstudio"/>
        <PackageReference Include="Shouldly"/>
        <PackageReference Include="Mapster"/>
    </ItemGroup>

    <ItemGroup>
        <Using Include="Xunit"/>
    </ItemGroup>

    <ItemGroup>
        <!-- Reference the generator as an analyzer so it runs during compilation -->
        <ProjectReference Include="..\DKNet.EfCore.DtoEntities\DKNet.EfCore.DtoEntities.csproj"/>
        <ProjectReference Include="..\DKNet.EfCore.DtoGenerator\DKNet.EfCore.DtoGenerator.csproj"
                          OutputItemType="Analyzer"
                          ReferenceOutputAssembly="true"/>
    </ItemGroup>

    <ItemGroup>
        <Folder Include="Features\StaticData\Currencies\Queries\"/>
    </ItemGroup>
</Project>
