<Project Sdk="Microsoft.NET.Sdk">

    <PropertyGroup>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
        <IsPackable>false</IsPackable>
        <!-- Disable code analysis for test entities -->
        <EnforceCodeStyleInBuild>false</EnforceCodeStyleInBuild>
        <EnableNETAnalyzers>false</EnableNETAnalyzers>
        <AnalysisMode>None</AnalysisMode>
        <RunAnalyzers>false</RunAnalyzers>
        <RunAnalyzersDuringBuild>false</RunAnalyzersDuringBuild>
        <RunAnalyzersDuringLiveAnalysis>false</RunAnalyzersDuringLiveAnalysis>
        <GenerateDocumentationFile>false</GenerateDocumentationFile>
        <NoWarn>$(NoWarn);CS1591;SA1600;DKDTOGEN004</NoWarn>
    </PropertyGroup>

    <!-- 1. Configure global exclusions for DTO generator -->
    <ItemGroup>
        <CompilerVisibleProperty Include="DtoGeneratorExclusions"/>
    </ItemGroup>
    <PropertyGroup>
        <DtoGeneratorExclusions>CreatedBy,UpdatedBy,CreatedAt,UpdatedAt</DtoGeneratorExclusions>
    </PropertyGroup>

    <!-- 2. Custom target to copy generated DTOs to project/GeneratedDtos folder, flattening structure and preserving names/extensions -->
    <Target Name="CopyGeneratedDtosToOutputFolder" AfterTargets="CoreCompile" Condition="Exists('$(CompilerGeneratedFilesOutputPath)')">
        <ItemGroup>
            <GeneratedDtoFiles Include="$(CompilerGeneratedFilesOutputPath)\**\*.g.cs"/>
        </ItemGroup>
        <MakeDir Directories="$(ProjectDir)GeneratedDtos" Condition="'@(GeneratedDtoFiles)' != ''"/>
        <Copy SourceFiles="@(GeneratedDtoFiles)"
              DestinationFiles="$(ProjectDir)GeneratedDtos\%(Filename)%(Extension)"
              SkipUnchangedFiles="false"
              OverwriteReadOnlyFiles="true"
              Condition="'@(GeneratedDtoFiles)' != ''"/>
        <Message Text="Copied %(Filename)%(Extension) to $(ProjectDir)GeneratedDtos" Importance="high" Condition="'@(GeneratedDtoFiles)' != ''"/>
    </Target>

    <!-- 3. Exclude generated DTOs from compilation, but keep them visible in Solution Explorer -->
    <ItemGroup>
        <Compile Remove="GeneratedDtos\**\*.cs"/>
        <None Include="GeneratedDtos\**\*.cs"/>
    </ItemGroup>

    <ItemGroup>
        <PackageReference Include="coverlet.collector"/>
        <PackageReference Include="Microsoft.NET.Test.Sdk"/>
        <PackageReference Include="xunit"/>
        <PackageReference Include="xunit.runner.visualstudio"/>
        <PackageReference Include="Shouldly"/>
        <PackageReference Include="Mapster"/>
    </ItemGroup>

    <ItemGroup>
        <Using Include="Xunit"/>
    </ItemGroup>

    <ItemGroup>
        <!-- Reference the generator as an analyzer so it runs during compilation -->
        <ProjectReference Include="..\DKNet.EfCore.DtoEntities\DKNet.EfCore.DtoEntities.csproj"/>
        <ProjectReference Include="..\DKNet.EfCore.DtoGenerator.Analyzers\DKNet.EfCore.DtoGenerator.Analyzers.csproj"/>
        <ProjectReference Include="..\DKNet.EfCore.DtoGenerator\DKNet.EfCore.DtoGenerator.csproj"
                          OutputItemType="Analyzer"
                          ReferenceOutputAssembly="true"/>
    </ItemGroup>

    <ItemGroup>
        <Folder Include="Features\StaticData\Currencies\Queries\"/>
    </ItemGroup>
</Project>
